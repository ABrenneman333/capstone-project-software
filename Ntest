import subprocess
from datetime import datetime

# MQTT configuration
MQTT_BROKER = "localhost"  # Replace with your MQTT broker IP
MQTT_PORT = 1883
MQTT_TOPIC = "/reading/temp"  # Replace with your topic

# Command to start mosquitto_sub and receive data
command = [
    "mosquitto_sub",
    "-h", MQTT_BROKER,
    "-p", str(MQTT_PORT),
    "-t", MQTT_TOPIC,
]

def parse_message(message):
    data = {}
    try:
        parts = message.split(",")
        for part in parts:
            key, value = part.split(":")
            data[key.strip()] = float(value.strip())
        return data
    except (ValueError, IndexError):
        print(f"Failed to parse message: {message}")
        return None

try:
    print("Listening for MQTT messages...")
    # Start the subprocess to listen to the MQTT topic
    with subprocess.Popen(command, stdout=subprocess.PIPE, text=True) as proc:
        for line in proc.stdout:
            line = line.strip()  # Remove any surrounding whitespace/newlines
            data = parse_message(line)
            
            if data:
                temperature = data.get("temperature")
                humidity = data.get("humidity")
                
                if temperature is not None and humidity is not None:
                    timestamp = datetime.now().isoformat()
                    print(f"Received Data - Temperature: {temperature}Â°C, Humidity: {humidity}% (Timestamp: {timestamp})")
                else:
                    print("Parsed data missing temperature or humidity:", data)
            else:
                print("Invalid data format received:", line)
except KeyboardInterrupt:
    print("\nStopped listening.")
except Exception as e:
    print(f"Error: {e}")
